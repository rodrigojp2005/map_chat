// Scripts do jogo extra√≠dos do welcome.blade.php
let map, streetView, currentLocation, userGuess;
let score = 1000;
let attempts = 5;
let round = 1;
let gameActive = true;
let locations = [];

// Locais padr√£o caso n√£o haja dados no backend
const defaultLocations = [
    { lat: -12.9714, lng: -38.5014, name: "Salvador, BA" }
];

window.initGame = function() {
    // Usar locais do backend ou locais padr√£o
    // A vari√°vel window.gameLocations √© definida no welcome.blade.php
    locations = window.gameLocations && window.gameLocations.length > 0 
                ? window.gameLocations 
                : defaultLocations;
    
    console.log('MapChat.js: Locais carregados para o jogo:', locations);
    
    // Verificar se √© a primeira visita (ou for√ßar tutorial)
    // Mant√©m compatibilidade: se j√° viu o tutorial com a chave antiga, respeita.
    const legacySeen = localStorage.getItem('gincaneiros_tutorial_seen');
    const newSeen = localStorage.getItem('mapchat_tutorial_seen');
    const showTutorial = !(legacySeen || newSeen) || window.location.search.includes('tutorial=1');
    
    if (showTutorial) {
        // Grava na nova chave e tamb√©m na antiga para n√£o quebrar vers√µes em cache
        localStorage.setItem('mapchat_tutorial_seen', 'true');
        localStorage.setItem('gincaneiros_tutorial_seen', 'true');
        showGameTutorial().then(() => {
            initializeGameComponents();
        });
    } else {
        initializeGameComponents();
    }
}

// Fun√ß√£o auxiliar para inicializar componentes do jogo
function initializeGameComponents() {
    initializeMap();
    initializeStreetView();
    setupEventListeners();
    startNewRound();
}

function initializeMap() {
    map = new google.maps.Map(document.getElementById('map'), {
        zoom: 4,
        center: { lat: -14.2350, lng: -51.9253 },
        mapTypeId: 'roadmap',
        zoomControl: true,
        streetViewControl: false,
        mapTypeControl: false,
        fullscreenControl: false,
        rotateControl: false,
        scaleControl: false,
        panControl: false,
        gestureHandling: 'greedy'
    });
    map.addListener('click', function(event) {
        if (gameActive) {
            userGuess = {
                lat: event.latLng.lat(),
                lng: event.latLng.lng()
            };
            if (window.userMarker) {
                window.userMarker.setMap(null);
            }
            window.userMarker = new google.maps.Marker({
                position: userGuess,
                map: map,
                title: 'Seu palpite',
                icon: 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png'
            } );
            updateMapInterface(true);
        }
    });
}

function initializeStreetView() {
    const cameraOffset = 0.00025;
    let characterPosition = getRandomValidLocation();
    let cameraPosition = {
        lat: characterPosition.lat - cameraOffset,
        lng: characterPosition.lng
    };

    function calculateHeading(from, to) {
        const dLng = to.lng - from.lng;
        const dLat = to.lat - from.lat;
        const angle = Math.atan2(dLng, dLat) * 180 / Math.PI;
        return (angle + 360) % 360;
    }

    const heading = calculateHeading(cameraPosition, characterPosition);

    streetView = new google.maps.StreetViewPanorama(
        document.getElementById('streetview'),
        {
            position: cameraPosition,
            pov: { heading: heading, pitch: 0 },
            zoom: 1,
            disableDefaultUI: true,
            showRoadLabels: false,
            motionTracking: false
        }
    );
    
    if (window.characterMarker) {
        window.characterMarker.setMap(null);
    }

    window.characterMarker = new google.maps.Marker({
        position: characterPosition,
        map: streetView,
        icon: {
            url: "https://media1.giphy.com/media/v1.Y2lkPTc5MGI3NjExeTRweGJoMHk1eG5nb2tyOHMyMHp1ZGlpYTFoZDZ6Ym9zZ3ZkYXB2MSZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9cw/bvQHYGOF8UOXqXSFir/giphy.gif",
            scaledSize: new google.maps.Size(60, 80 ),
            anchor: new google.maps.Point(30, 80)
        },
        visible: true
    });

    window.characterMarker.addListener('click', function() {
        showPostModal(currentLocation);
    });
    
    streetView.addListener('status_changed', function() {
        if (streetView.getStatus() !== 'OK') {
            console.warn('Street View n√£o dispon√≠vel, tentando outra localiza√ß√£o...');
            const newPosition = getRandomValidLocation();
            streetView.setPosition(newPosition);
            if (window.characterMarker) {
                window.characterMarker.setPosition(newPosition);
            }
        }
    });
}

function getRandomValidLocation() {
    let validLocations = [];
    if (locations && locations.length > 0) {
        validLocations = locations.filter(loc => !loc.no_gincana);
    }
    if (validLocations.length === 0) {
        validLocations = defaultLocations;
    }
    const randomLocation = validLocations[Math.floor(Math.random() * validLocations.length)];
    console.log('MapChat.js: Localiza√ß√£o selecionada:', randomLocation.name || 'Local aleat√≥rio');
    return { lat: randomLocation.lat, lng: randomLocation.lng };
}

function setupEventListeners() {
    document.getElementById('showMapBtn').addEventListener('click', showMap);
    document.getElementById('closeMapBtn').addEventListener('click', hideMap);
    document.getElementById('confirmGuessBtn').addEventListener('click', confirmGuess);
    document.getElementById('continueBtn').addEventListener('click', hidePopup);
    document.getElementById('overlay').addEventListener('click', hidePopup);
}

function startNewRound() {
    if (locations.length === 0) {
        console.error('Nenhum local dispon√≠vel para o jogo');
        return;
    }
    currentLocation = locations[Math.floor(Math.random() * locations.length)];
    console.log('MapChat.js: Local atual da rodada:', currentLocation);
    
    setTimeout(() => {
        const cameraOffset = 0.00025;
        let characterPosition = { lat: currentLocation.lat, lng: currentLocation.lng };
        let cameraPosition = { lat: characterPosition.lat - cameraOffset, lng: characterPosition.lng };

        function calculateHeading(from, to) {
            const dLng = to.lng - from.lng;
            const dLat = to.lat - from.lat;
            const angle = Math.atan2(dLng, dLat) * 180 / Math.PI;
            return (angle + 360) % 360;
        }
        const heading = calculateHeading(cameraPosition, characterPosition);
        streetView.setPosition(cameraPosition);
        streetView.setPov({ heading: heading, pitch: 0 });
        if (window.characterMarker) {
            window.characterMarker.setPosition(characterPosition);
        }
    }, 500);
    
    if (window.userMarker) window.userMarker.setMap(null);
    if (window.correctMarker) window.correctMarker.setMap(null);
    userGuess = null;
    gameActive = true;
    updateUI();
    updateMapInterface(false);
}

function updateMapInterface(hasGuess) {
    const confirmBtn = document.getElementById('confirmGuessBtn');
    const instructions = document.getElementById('mapInstructions');
    if (!confirmBtn || !instructions) return;
    
    if (hasGuess) {
        confirmBtn.disabled = false;
        confirmBtn.classList.add('has-guess');
        confirmBtn.textContent = 'üéØ Confirmar Palpite';
        instructions.classList.add('hidden');
    } else {
        confirmBtn.disabled = true;
        confirmBtn.classList.remove('has-guess');
        confirmBtn.textContent = 'üéØ Clique no mapa primeiro';
        instructions.classList.remove('hidden');
    }
}

function showMap() {
    document.getElementById('mapSlider').classList.add('active');
    updateMapInterface(!!userGuess);
}

function hideMap() {
    document.getElementById('mapSlider').classList.remove('active');
}

function confirmGuess() {
    if (!userGuess) {
        Swal.fire({ icon: 'warning', title: 'Aten√ß√£o!', text: 'Por favor, clique no mapa para fazer seu palpite!', confirmButtonColor: '#007bff' });
        return;
    }
    
    const distance = calculateDistance(currentLocation, userGuess);
    attempts--;
    let message = `Voc√™ est√° √† ${distance.toFixed(2)} km do local, `;
    let title = `Siga nessa dire√ß√£o ...`;
    let icon = 'info';
    
    if (distance <= 10) {
        title = 'Parab√©ns! üéâ';
        icon = 'success';
        message += `\n\nVoc√™ acertou! A localiza√ß√£o era: ${currentLocation.name}`;
        message += `\n\nPontua√ß√£o final: ${score} pontos`;
        saveScoreToDatabase(score, currentLocation);
        endRound(true);
        Swal.fire({ icon: icon, title: title, text: message, confirmButtonText: 'Novo Jogo', confirmButtonColor: '#007bff', allowOutsideClick: false }).then((result) => {
            if (result.isConfirmed) {
                hideMap();
                location.reload();
            }
        });
    } else {
        score = Math.max(0, score - 200);
        icon = 'error';
        if (attempts > 0) {
            const direction = getDirection(currentLocation, userGuess);
            let directionImg = '';
            switch (direction) {
                case 'Norte': directionImg = 'https://media4.giphy.com/media/v1.Y2lkPTc5MGI3NjExNGt2MXQzdmY3eHFrYzNkcjNmcnhhbWl5emlzYjNibnR5ZmEwc2locyZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9cw/7aFMOMlY5HgQnCcK5n/giphy.gif'; break;
                case 'Sul': directionImg = 'https://media4.giphy.com/media/v1.Y2lkPTc5MGI3NjExeWwxbW12a2ExZTByd2x4aGxxdjhrbjJxdmJhZDJkZ2x3aW12czY2aiZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9cw/jfxNsKqJLIc3Kw1nZz/giphy.gif'; break;
                case 'Leste': directionImg = 'https://media0.giphy.com/media/v1.Y2lkPTc5MGI3NjExZmlwZXAydHE4cmszOHlpdDBudnd4OTd6cW4ybjhrODVzMW5tMGQxZCZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9cw/A0Mmm3WcsQVrMlYjlY/giphy.gif'; break;
                case 'Oeste': directionImg = 'https://media4.giphy.com/media/v1.Y2lkPTc5MGI3NjExeWd5aW5nbnpreWNlcXh6MHk1aDVtMWJkdTJoOW15bm1ycHcwb2swciZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9cw/CGTFfpxHMpxCJk1eGR/giphy.gif'; break;
            }
            message += `\n\n v√° mais para o ${direction}.`;
            message += `\n\n Falta(m ) ${attempts} tentativa(s).`;
            message += `\n\n Pontua√ß√£o atual: ${score} pts.`;
            Swal.fire({ title: title, text: message.replace(/\n/g, ' '), imageUrl: directionImg, imageWidth: 150, imageHeight: 150, imageAlt: direction, confirmButtonColor: '#007bff', confirmButtonText: 'Continuar', allowOutsideClick: false });
        } else {
            title = 'Fim de Jogo';
            message += `\n\nSuas tentativas acabaram!`;
            message += `\n\nA localiza√ß√£o era: ${currentLocation.name}`;
            message += `\n\nPontua√ß√£o final: ${score} pontos`;
            saveScoreToDatabase(score, currentLocation);
            endRound(false);
            Swal.fire({ icon: icon, title: title, text: message, confirmButtonText: 'Novo Jogo', confirmButtonColor: '#007bff', allowOutsideClick: false }).then((result) => {
                if (result.isConfirmed) {
                    hideMap();
                    location.reload();
                }
            });
        }
    }
    updateUI();
}

function calculateDistance(pos1, pos2) {
    const R = 6371;
    const dLat = (pos2.lat - pos1.lat) * Math.PI / 180;
    const dLng = (pos2.lng - pos1.lng) * Math.PI / 180;
    const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(pos1.lat * Math.PI / 180) * Math.cos(pos2.lat * Math.PI / 180) * Math.sin(dLng/2) * Math.sin(dLng/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
}

function getDirection(target, guess) {
    const dLat = target.lat - guess.lat;
    const dLng = target.lng - guess.lng;
    return Math.abs(dLat) > Math.abs(dLng) ? (dLat > 0 ? 'Norte' : 'Sul') : (dLng > 0 ? 'Leste' : 'Oeste');
}

function endRound(won) {
    gameActive = false;
    window.correctMarker = new google.maps.Marker({ position: currentLocation, map: map, title: 'Localiza√ß√£o correta', icon: 'http://maps.google.com/mapfiles/ms/icons/red-dot.png' } );
}

function updateUI() {
    // Apenas atualiza se os elementos existirem (para n√£o dar erro para visitantes)
    if (document.getElementById('score')) document.getElementById('score').textContent = score;
    if (document.getElementById('attempts')) document.getElementById('attempts').textContent = attempts;
    if (document.getElementById('round')) document.getElementById('round').textContent = round;
}

function hidePopup() { console.log('hidePopup chamada'); }

// ########## IN√çCIO DA CORRE√á√ÉO ##########

// Listener de evento que espera a estrutura da p√°gina (DOM) estar pronta.
// Isso garante que a tag <script> no welcome.blade.php j√° definiu window.gameLocations.
document.addEventListener('DOMContentLoaded', () => {
    // Verificar se a vari√°vel global com os locais foi definida pelo Laravel.
    if (typeof window.gameLocations === 'undefined') {
    console.error('MapChat.js: A vari√°vel window.gameLocations n√£o foi encontrada. Verifique o welcome.blade.php');
        return; // Interrompe a execu√ß√£o se os dados n√£o estiverem dispon√≠veis.
    }

    // Verificar se h√° gincanas dispon√≠veis
    if (window.gameLocations.length === 1 && window.gameLocations[0].no_gincana) {
        showNoGincanaAlert();
        return;
    }
    
    // Agora que temos os dados, esperamos a API do Google Maps carregar.
    // A API √© carregada por uma tag <script> no layouts/app.blade.php.
    // A fun√ß√£o initGame() agora √© chamada globalmente pelo callback da API do Google.
    // N√£o precisamos mais do setInterval. A fun√ß√£o initGame se torna o ponto de entrada.
});

// A fun√ß√£o initGame j√° existe e √© chamada pelo callback da API do Google Maps.
// O importante √© que o script da API do Google seja carregado em todas as p√°ginas.
// Verifique se a linha abaixo est√° no seu layouts/app.blade.php, fora de qualquer condicional.
// <script async src="https://maps.googleapis.com/maps/api/js?key=SUA_CHAVE_API&callback=initGame"></script>

// (O restante do seu c√≥digo, como saveScoreToDatabase, showNoGincanaAlert, etc., permanece igual )
// ... (c√≥digo omitido para brevidade) ...

// ########## FIM DA CORRE√á√ÉO ##########
// Fun√ß√£o para salvar pontua√ß√£o no banco de dados
async function saveScoreToDatabase(pontuacao, location) {
    try {
        // Verificar se o usu√°rio est√° logado (se existe um token CSRF)
        const csrfToken = document.querySelector('meta[name="csrf-token"]');
        if (!csrfToken) {
            console.log('Usu√°rio n√£o logado - pontua√ß√£o n√£o ser√° salva');
            return;
        }

        const response = await fetch('/game/save-score', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-TOKEN': csrfToken.getAttribute('content'),
                'Accept': 'application/json'
            },
            body: JSON.stringify({
                gincana_id: location.gincana_id || null, // ID da gincana se estiver jogando uma espec√≠fica
                pontuacao: pontuacao,
                tempo_total_segundos: null, // Podemos implementar timer depois
                locais_visitados: 1,
                latitude: location.lat,
                longitude: location.lng
            })
        });

        const data = await response.json();
        
        if (data.success) {
            console.log('Pontua√ß√£o salva com sucesso!', data);
        } else {
            console.error('Erro ao salvar pontua√ß√£o:', data);
        }
    } catch (error) {
        console.error('Erro na requisi√ß√£o para salvar pontua√ß√£o:', error);
    }
}

// Fun√ß√£o para mostrar alerta quando n√£o h√° gincanas dispon√≠veis
function showNoGincanaAlert() {
    // Ocultar elementos do jogo
    const gameContainer = document.querySelector('.game-container');
    if (gameContainer) {
        gameContainer.style.display = 'none';
    }
    
    // Verificar se o usu√°rio est√° autenticado
    const isAuthenticated = window.isAuthenticated || false;
    
    if (isAuthenticated) {
        // Usu√°rio logado - mostrar op√ß√£o de criar gincana
        Swal.fire({
            title: 'üéØ Nenhuma Gincana Dispon√≠vel',
            text: 'N√£o h√° gincanas p√∫blicas criadas ainda. Que tal ser o primeiro a criar uma?',
            icon: 'info',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#6c757d',
            confirmButtonText: 'üéÆ Criar Minha Gincana',
            cancelButtonText: 'Cancelar',
            background: '#fff',
            allowOutsideClick: false,
            backdrop: `
                rgba(0,0,123,0.4)
                left top
                no-repeat
            `
        }).then((result) => {
            if (result.isConfirmed) {
                // Redirecionar para a p√°gina de cria√ß√£o de gincana
                window.location.href = '/gincana/create';
            } else {
                // Se cancelar, mostrar container do jogo novamente
                if (gameContainer) {
                    gameContainer.style.display = 'block';
                }
            }
        });
    } else {
        // Visitante - informar sobre login
        Swal.fire({
            title: 'üéØ Nenhuma Gincana Dispon√≠vel',
            text: 'N√£o h√° gincanas p√∫blicas criadas ainda. Fa√ßa login para criar sua pr√≥pria gincana!',
            icon: 'info',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#6c757d',
            confirmButtonText: 'üîê Fazer Login',
            cancelButtonText: 'Ok',
            background: '#fff',
            allowOutsideClick: false,
            backdrop: `
                rgba(0,0,123,0.4)
                left top
                no-repeat
            `
        }).then((result) => {
            if (result.isConfirmed) {
                // Redirecionar para a p√°gina de login
                window.location.href = '/login';
            } else {
                // Se cancelar, mostrar container do jogo novamente
                if (gameContainer) {
                    gameContainer.style.display = 'block';
                }
            }
        });
    }
}

// Fun√ß√£o para mostrar tutorial explicativo do jogo
function showGameTutorial() {
    return Swal.fire({
        title: "Vc √© bom de investiga√ß√£o?",
        text: " Vamos testar suas habilidades e ver se voc√™ consegue indentificar este local! üïµÔ∏è‚Äç‚ôÇÔ∏è",
        imageUrl: "https://media4.giphy.com/media/v1.Y2lkPTc5MGI3NjExOG4wcTBrN2hpaDlhaGl0MHVnNDk5ZGo3ODNsa3V2YzI5c3R1aWdsNSZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/l378tV67u1QQkSqFq/giphy.gif",
        imageWidth: 400,
        imageHeight: 200,
        imageAlt: "Custom image",
        confirmButtonText: "Vamos l√°! üöÄ"
    });
}

// Nova fun√ß√£o para mostrar modal com coment√°rios
function showPostModal(location) {
    const isAuthenticated = window.isAuthenticated || false;
    
    Swal.fire({
        title: location.name || 'Local Misterioso',
        html: `
            <div class="post-content" style="text-align: left;">
                <div class="post-inicial" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <h4 style="margin: 0 0 10px 0; color: #495057;">üìç Dica do Local:</h4>
                    <p style="margin: 0; color: #6c757d; font-style: italic;">"${location.contexto || 'Descubra onde estou!'}"</p>
                </div>
                
                <div class="comments-section">
                    <h4 style="margin: 0 0 15px 0; color: #495057;">üí¨ Coment√°rios da Comunidade</h4>
                    <div id="comments-list" style="max-height: 300px; overflow-y: auto; margin-bottom: 15px;">
                        <div style="text-align: center; color: #6c757d;">
                            <i class="fas fa-spinner fa-spin"></i> Carregando coment√°rios..
                        </div>
                    </div>
                    
                    ${isAuthenticated ? `
                        <div class="add-comment" style="border-top: 1px solid #dee2e6; padding-top: 15px;">
                            <textarea id="new-comment" placeholder="Compartilhe sua experi√™ncia sobre este local..." 
                                style="width: 100%; height: 80px; padding: 10px; border: 1px solid #ced4da; border-radius: 4px; resize: vertical; font-family: inherit;"></textarea>
                            <button onclick="addComment(${location.gincana_id || location.id})" 
                                style="margin-top: 10px; background: #007bff; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
                                üí¨ Comentar
                            </button>
                        </div>
                    ` : `
                        <div style="text-align: center; padding: 15px; background: #e9ecef; border-radius: 4px;">
                            <p style="margin: 0; color: #6c757d;">
                                üîê Fa√ßa login  para comentar e interagir com a comunidade!
                            </p>
                        </div>
                    `}
                </div>
            </div>
        `,
        width: 600,
        showCloseButton: true,
        showConfirmButton: false,
        didOpen: () => {
            // S√≥ carrega coment√°rios se o usu√°rio estiver autenticado
            if (window.isAuthenticated) {
                loadComments(location.gincana_id || location.id);
            }
        }
    });
}

// Fun√ß√£o para carregar coment√°rios
async function loadComments(gincanaId) {
    try {
        console.log('Carregando coment√°rios para gincana_id:', gincanaId);
        
        const response = await fetch(`/comentarios/${gincanaId}`);
        
        // Verificar se a resposta √© OK
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        // Verificar se √© JSON v√°lido
        const textResponse = await response.text();
        console.log('Resposta do servidor:', textResponse.substring(0, 500)); // Log dos primeiros 500 caracteres
        
        let comentarios;
        try {
            comentarios = JSON.parse(textResponse);
        } catch (jsonError) {
            console.error('Erro ao parsear JSON:', jsonError);
            console.error('Resposta completa:', textResponse);
            throw new Error('Resposta n√£o √© um JSON v√°lido');
        }
        
        const commentsList = document.getElementById('comments-list');
        if (!commentsList) return;
        
        if (comentarios.length === 0) {
            commentsList.innerHTML = `
                <div style="text-align: center; color: #6c757d; padding: 20px;">
                    ü§î Seja o primeiro a comentar sobre este local!
                </div>
            `;
            return;
        }
        
        commentsList.innerHTML = comentarios.map(comentario => `
            <div class="comment" style="border-bottom: 1px solid #eee; padding: 12px 0;">
                <div style="display: flex; align-items: center; margin-bottom: 8px;">
                    <strong style="color: #495057; font-size: 14px;">${comentario.user.name}</strong>
                    <small style="color: #6c757d; margin-left: 10px;">${formatDate(comentario.created_at)}</small>
                </div>
                <p style="margin: 0; color: #495057; line-height: 1.4; font-size: 14px;">${comentario.conteudo}</p>
            </div>
        `).join('');
        
    } catch (error) {
        console.error('Erro ao carregar coment√°rios:', error);
        document.getElementById('comments-list').innerHTML = `
            <div style="text-align: center; color: #dc3545;">
                ‚ùå Erro ao carregar coment√°rios: ${error.message}
            </div>
        `;
    }
}

//Fun√ß√£o para adicionar coment√°rio
window.addComment = async function(gincanaId) {
    const textarea = document.getElementById('new-comment');
    const conteudo = textarea.value.trim();
    
    if (!conteudo) {
        Swal.fire({
            icon: 'warning',
            title: 'Aten√ß√£o',
            text: 'Digite seu coment√°rio primeiro!',
            confirmButtonColor: '#007bff'
        });
        return;
    }
    
    try {
        console.log('Enviando coment√°rio para gincana_id:', gincanaId);
        
        const csrfToken = document.querySelector('meta[name="csrf-token"]');
        const response = await fetch('/comentarios', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-TOKEN': csrfToken.getAttribute('content'),
                'Accept': 'application/json'
            },
            body: JSON.stringify({
                gincana_id: gincanaId,
                conteudo: conteudo
            })
        });
        
        // Verificar se a resposta √© OK
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        // Verificar se √© JSON v√°lido
        const textResponse = await response.text();
        console.log('Resposta do servidor (coment√°rio):', textResponse.substring(0, 500));
        
        let data;
        try {
            data = JSON.parse(textResponse);
        } catch (jsonError) {
            console.error('Erro ao parsear JSON:', jsonError);
            console.error('Resposta completa:', textResponse);
            throw new Error('Resposta n√£o √© um JSON v√°lido');
        }
        
        if (data.success) {
            textarea.value = '';
            loadComments(gincanaId);
            
            Swal.fire({
                toast: true,
                position: 'top-end',
                icon: 'success',
                title: 'Coment√°rio adicionado!',
                showConfirmButton: false,
                timer: 2000
            });
        } else {
            throw new Error(data.message || 'Erro ao adicionar coment√°rio');
        }
        
    } catch (error) {
        console.error('Erro ao adicionar coment√°rio:', error);
        Swal.fire({
            icon: 'error',
            title: 'Erro',
            text: `N√£o foi poss√≠vel adicionar seu coment√°rio: ${error.message}`,
            confirmButtonColor: '#dc3545'
        });
    }
}

// // Fun√ß√£o para adicionar coment√°rio
// window.addComment = async function(gincanaId) {
//     const textarea = document.getElementById('new-comment');
//     const conteudo = textarea.value.trim();
    
//     if (!conteudo) {
//         Swal.fire({
//             icon: 'warning',
//             title: 'Aten√ß√£o',
//             text: 'Digite seu coment√°rio primeiro!',
//             confirmButtonColor: '#007bff'
//         });
//         return;
//     }
    
//     try {
//         console.log('Enviando coment√°rio para gincana_id:', gincanaId);
        
//         const csrfToken = document.querySelector('meta[name="csrf-token"]');
//         const response = await fetch('/comentarios', {
//             method: 'POST',
//             headers: {
//                 'Content-Type': 'application/json',
//                 'X-CSRF-TOKEN': csrfToken.getAttribute('content'),
//                 'Accept': 'application/json'
//             },
//             body: JSON.stringify({
//                 gincana_id: gincanaId,
//                 conteudo: conteudo
//             })
//         });
        
//         // Verificar se a resposta √© OK (status 2xx)
//         if (!response.ok) {
//             // Se a resposta n√£o for OK, mas o coment√°rio foi salvo,
//             // vamos tratar como sucesso no front-end.
//             // O erro de JSON ser√° pego no catch abaixo.
//             throw new Error(`HTTP error! status: ${response.status}`);
//         }
        
//         const textResponse = await response.text();
//         const data = JSON.parse(textResponse); // Esta linha pode falhar e ir para o catch
        
//         if (data.success) {
//             // Bloco de sucesso original (quando o servidor retorna JSON)
//             textarea.value = '';
//             loadComments(gincanaId);
            
//             Swal.fire({
//                 toast: true,
//                 position: 'top-end',
//                 icon: 'success',
//                 title: 'Coment√°rio adicionado!',
//                 showConfirmButton: false,
//                 timer: 2000
//             });
//         } else {
//             throw new Error(data.message || 'Erro ao adicionar coment√°rio');
//         }
        
//     } catch (error) {
//         // ########## IN√çCIO DA MODIFICA√á√ÉO ##########
//         // ESTE BLOCO AGORA VAI TRATAR O ERRO COMO SUCESSO
        
//         console.warn('Ocorreu um erro esperado no servidor ap√≥s salvar o coment√°rio. Tratando como sucesso no front-end.', error);
        
//         // 1. Limpar a caixa de texto
//         textarea.value = '';
        
//         // 2. Recarregar a lista de coment√°rios para mostrar o novo
//         loadComments(gincanaId);
        
//         // 3. Mostrar o pop-up de SUCESSO
//         Swal.fire({
//             toast: true,
//             position: 'top-end',
//             icon: 'success',
//             title: 'Coment√°rio adicionado!',
//             showConfirmButton: false,
//             timer: 2000
//         });
        
//         // ########## FIM DA MODIFICA√á√ÉO ##########
//     }
// }

// Fun√ß√£o para formatar data
function formatDate(dateString) {
    const date = new Date(dateString);
    const now = new Date();
    const diffInHours = (now - date) / (1000 * 60 * 60);
    
    if (diffInHours < 1) {
        return 'Agora mesmo';
    } else if (diffInHours < 24) {
        return `${Math.floor(diffInHours)}h atr√°s`;
    } else {
        return date.toLocaleDateString('pt-BR');
    }
}
